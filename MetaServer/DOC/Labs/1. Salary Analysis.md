
# Лабораторная работа № 1
***
Задача: Провести в фирме максимальную индексацию зарплат с учетом бизнес правил.
Время проведения индексации: декабрь 2013 года
***
Бизнес правила:
1. Повышение ЗП максимум 2 раза в год
2. Максимальное повышение ЗП на 30% в год
***
Что используется при решении:

1. Hive
2. Oozie
3. Livy
4. СУБД postgres (Adventureworks)
5. Schema: humanresources
***

Рекомендации:
1. Переключиться на английский язык интерфейса

***
## Шаг 1. Создать Project
1. Перейти в раздел ETL -> Project
2. Нажать “+” -> Project
3. Заполнить поле Name: testProject
4. Сохранить

## Шаг 2. Создать Подключение к СУБД
### 2.1. Создать Context
>##### №1
1. Перейти через BreadCrumb на вкладку ETL   
2. Выбрать раздел JdbcContext
3. Нажать “+” -> JdbcContext
4. Заполнить поле Name: awTestHR
5. Сохранить

>##### №2
1. Перейти через BreadCrumb на вкладку Jdbc Context
2. Нажать “+” -> JdbcContext
3. Заполнить поле Name: awTestPerson
4. Сохранить

### 2.2. Создать Software System
>##### №1
1. Перейти через BreadCrumb на вкладку Home
2. Выбрать раздел Connections
3. Выбрать раздел SoftwareSystem
4. Нажать “+” -> SoftwareSystem
5. Заполнить поля:
   - Name: awTestHR
   - Project: выбрать testProject
6. Сохранить
   
>##### №2
1. Перейти через BreadCrumb на вкладку Software System
2. Нажать “+” -> Software System
3. Заполнить поля:
   - Name: awTestPerson
   - Project: выбрать testProject
4. Сохранить
> Важно! Name в JdbcContext должно совпадать с Name в Software System

> Оставшиеся поля заполнятся автоматически в конце Шага 2

### Шаг 2.3. Создать JdbcConnection
>##### №1
1. Перейти через BreadCrumb на вкладку Connections
2. Выбрать раздел JdbcConnection
3. Нажать “+” -> JdbcConnection
4. Заполнить поля 
    - Name: awTestHR
    - Project: выбрать testProject
    - Url: jdbc:postgresql://hivemetastore:5432/Adventureworks
    - Schema: humanresources
    - User: postgres
    - Password: new_password
    - Driver: org.postgresql.Driver
5. Сохранить
6. Запустить Test
7. Получить сообщение об успешном соединении
   
>##### №2
1. Перейти через BreadCrumb на вкладку Jdbc Connection
3. Нажать “+” -> JdbcConnection
4. Заполнить поля 
    - Name: awTestPerson
    - Project: выбрать testProject
    - Url: jdbc:postgresql://hivemetastore:5432/Adventureworks
    - Schema: person
    - User: postgres
    - Password: new_password
    - Driver: org.postgresql.Driver
5. Сохранить
6. Запустить Test
7. Получить сообщение об успешном соединении

### Шаг 2.4. Создать Deployment
>##### №1
1. Перейти через BreadCrumb на вкладку Connections
2. Выбрать раздел Deployment
3. Нажать “+” -> Deployment
4. Заполнить поля:
    - Name: awTestHR
    - Project: выбрать testProject
    - Connection: Выбрать awTestHR
    - Software System: awTestHR
5. Сохранить
6. Запустить Refresh Scheme
7. Получить сообщение об успешном соединении

>##### №2
1. Перейти через BreadCrumb на вкладку Deployment
2. Нажать “+” -> Deployment
3. Заполнить поля:
   - Name: awTestPerson
   - Project: выбрать testProject
   - Connection: Выбрать awTestPerson
   - Software System: awTestPerson
4. Сохранить
5. Запустить Refresh Scheme
6. Получить сообщение об успешном соединении

> Важно! Если при запуске Refresh Scheme возникла ошибка 
> "id to load is required for loading".
> Кнопка сохранить не отработала, нужно нажать её еще раз и повторить запуск Refresh Scheme

### Шаг 2.5. Проверить автоматически созданную Scheme
>##### №1
1. Перейти через BreadCrumb на вкладку Connections
2. Выбрать раздел Scheme
3. Проверить наличие humanresources_at_awTestHR (она как раз создалась)
4. Перейти в режим редактирования 
5. Развернуть Tables (6 штук)

>##### №2
1. Перейти через BreadCrumb на вкладку Scheme
2. Проверить наличие person_at_awTestPerson (она как раз создалась)
3. Перейти в режим редактирования
4. Развернуть Tables (13 штук)

### Шаг 3. Спроектировать структуру Project

>##### №1
1. Перейти через BreadCrumb на вкладку Home
2. Выбрать раздел ETL
3. Выбрать раздел Transformation
4. Нажать “+” -> Transformation
5. Заполнить поля:
   - Name: tr_salary_step1_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject             
   - Spark Version: Выбрать SPARK3
   - Description: 
        ```
        Задача: Провести индексацию зарплат с учетом бизнес правил.
        Время проведения: декабрь 2013 года
        
        Правила бизнеса:
        1. Повышать ЗП максимум 2 раза в год
        2. Максимальное повышение ЗП 30% в год
        3. В случае несоблюдения правил 1 или 2, необходимо согласование руководителя компании.
        
        В Step 1: Формирование двух таблиц:
        1. Последнее повышение ЗП сотруднику
        2. Предпоследнее повышение ЗП сотруднику
        ```
6. Сохранить 

>##### №2
1. Перейти через BreadCrumb на вкладку Transformation
2. Нажать “+” -> Transformation
3. Заполнить поля:
   - Name: tr_salary_step2_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject             
   - Spark Version: Выбрать SPARK3
   - Description: 
        ```
        Задача: Провести индексацию зарплат с учетом бизнес правил.
        Время проведения: декабрь 2013 года
        
        Правила бизнеса:
        1. Повышать ЗП максимум 2 раза в год
        2. Максимальное повышение ЗП 30% в год
        3. В случае несоблюдения правил 1 или 2, необходимо согласование руководителя компании.
        
        В Step 2:
        1. Формирование таблицы с сотрудниками, кому повышали ЗП за предыдущий год.
        2. Вычисление % повышения ЗП в 2014 году
        
        Примечание:
        Чтобы посмотреть все таблицы в Hive, нужно в Livy ввести команду: "spark.sql("show tables").show()"
        ```
4. Сохранить 

>##### №3
1. Перейти через BreadCrumb на вкладку Transformation
2. Нажать “+” -> Transformation
3. Заполнить поля:
   - Name: tr_salary_step3_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject             
   - Spark Version: Выбрать SPARK3
   - Description: 
        ```
        Задача: Провести индексацию зарплат с учетом бизнес правил.
        Время проведения: декабрь 2013 года
        
        Правила бизнеса:
        1. Повышать ЗП максимум 2 раза в год
        2. Максимальное повышение ЗП 30% в год
        3. В случае несоблюдения правил 1 или 2, необходимо согласование руководителя компании.
        
        В Step 3: Формирование итоговой таблицы
        ```
4. Сохранить 

>##### №4
1. Перейти через BreadCrumb на вкладку ETL
2. Выбрать раздел Workflow
3. Нажать “+” -> Workflow
4. Заполнить поля:
   - Name: wf_salary_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject
5. Сохранить 

>##### №5
1. Увидеть открывшийся редактор Workflow
2. Перетащить на поле иконки:
     - Start
     - Transformation (3 шт)
     - Kill
     - End
3. Соединить их, как показано на рисунке:
    ![](img/1.%20Salary%20Analysis/Step%203.5.PNG)
4. Сохранить

>##### №6
1. Нажать на Start
2. Справа в Свойствах:
     - Name: заменить на "Start"
     - Label: Автоматически подставляется "= Name"
4. Сохранить

>##### №7
1. Нажать на Transformation_1
2. Справа в Свойствах:
     - Name: заменить на "Step1"
     - Label: Автоматически подставляется "= Name"
     - Transformation: Выбрать tr_salary_step1_test
3. Сохранить

>##### №8
1. Нажать на Transformation_2
2. Справа в Свойствах:
     - Name: заменить на "Step2"
     - Label: Автоматически подставляется "= Name"
     - Transformation: Выбрать tr_salary_step2_test
3. Сохранить

>##### №9
1. Нажать на Transformation_3
2. Справа в Свойствах:
     - Name: заменить на "Step3"
     - Label: Автоматически подставляется "= Name"
     - Transformation: Выбрать tr_salary_step3_test
3. Сохранить

>##### №10
1. Нажать на Kill_3
2. Справа в Свойствах:
     - Name: заменить на "Error"
     - Label: заменить на "Error"
     - Message: Ошибка запуска отчета анализа зарплат
3. Сохранить

>##### №11
1. Нажать на End_4
2. Справа в Свойствах:
     - Name: заменить на "Success"
     - Label: заменить на "Success"
3. Сохранить
4. Слева в Transformation должны появится три Transformation, подключенных к данному Workflow

>##### №12
1. Перейти через BreadCrumb на вкладку ETL
2. Выбрать раздел Project -> testProject
3. Убедиться, что Workflow и 3 Transformation подключены к проекту

### Шаг 4. Настроить Transformation Step1
>##### №1
1. Перейти через левое меню в tr_salary_step1_test
2. Перетащить на поле иконки из Source:
     - SQL (2 шт)
3. Перетащить на поле иконки из Transformation:
    - Aggregation
    - Join
    - Projection
4. Перетащить на поле иконку из Target:
    - Local
3. Соединить их, как показано на рисунке:
        ![](img/1.%20Salary%20Analysis/Step%204.1.PNG)
4. Сохранить

>##### №2
1. Нажать на SQL_0
2. Справа в Свойствах:
     - Context: Выбрать awTestHR
3. Сохранить
4. Под иконкой SQL_0 нажать TXT (Edit SQL)
5. Открылся новый Tab SQL Editor SQL_0
6. Вставить запрос в поле:
    ```
    select
        businessentityid,
        ROW_NUMBER() OVER(PARTITION BY businessentityid ORDER BY ratechangedate DESC) as 
            payRateNumber
    from humanresources.employeepayhistory
    ```
7. Нажать Run
8. Посмотреть, что под запросом появилась чашка кофе
9. Посмотреть, что внизу закрутилась шестеренка и стала голубой
10. Подождать, пока запрос отработает и вернет нам таблицу
11. Нажать галочку (Apply) = Сохраняем запрос в SQL_0
12. Вернуться в первый Tab Transformation Transformation Designer
13. Нажать на SQL_0
14. Посмотреть, что в свойстве Statement появился запрос
15. Посмотреть, что в свойстве Output Port: OutputPort -> Fields появились 2 поля, которые вернулись из запроса с названием колонок и типом данных

>##### №3
1. Нажать на SQL_1
2. Справа в Свойствах:
     - Context: Выбрать awTestHR
3. Сохранить
4. Под иконкой SQL_1 нажать TXT (Edit SQL)
5. Открылся новый Tab SQL Editor SQL_1
6. Вставить запрос в поле:
    ```
    select
    	businessentityid as businessentityid_2,
    	ROW_NUMBER() OVER(PARTITION BY businessentityid ORDER BY ratechangedate DESC) as 
            payRateNumber_2,
    	ratechangedate as date_2,
            rate as rate_2
    from humanresources.employeepayhistory
    ```
7. Нажать Run
8. Посмотреть, что под запросом появилась чашка кофе
9. Посмотреть, что внизу закрутилась шестеренка и стала голубой
10. Подождать, пока запрос отработает и вернет нам таблицу
11. Нажать галочку (Apply) = Сохраняем запрос в SQL_1
12. Вернуться в первый Tab Transformation Transformation Designer
13. Нажать на SQL_1
14. Посмотреть, что в свойстве Statement появился запрос
15. Посмотреть, что в свойстве Output Port: OutputPort -> Fields появились 4 поля, которые вернулись из запроса с названием колонок и типом данных




### Шаг 5. Настроить Transformation Step2

### Шаг 6. Настроить Transformation Step3