
# Лабораторная работа № 1
***
Задача: Провести индексацию зарплат с учетом бизнес правил в декабре 2013 года.
***
Бизнес правила:
1. Повышение ЗП максимум 1 раз в год
2. Максимальное повышение ЗП за год - 20%
3. В случае несоблюдения правил 1 или 2, необходимо согласование руководителя компании
***
Что используется при решении:

1. Hive
2. Oozie
3. Livy
4. СУБД postgres (Adventureworks)
5. Schema: humanresources, person
***

Рекомендации:
1. Переключиться на английский язык интерфейса

***
## Шаг 1. Анализ задачи
1. На выходе нужны таблицы:
   - Повышения ЗП за прошедший год
   - Сотрудники, которым требуется согласование руководителя компании для повышения ЗП
   - Сотрудники, которым не требуется согласование руководителя компании для повышения ЗП
2. Разбить по шагам:
   - Подключиться к СУБД
   - Сформировать таблицу повышений за прошедший год 
   - Сформировать таблицы с плановыми повышениями ЗП в следующем году.
3. Необходимые
4. 

## Шаг 2. Создать Project
1. Перейти в раздел Home/ETL/Project
2. Нажать “+” -> Project
3. Заполнить поле Name: labWorks
4. Сохранить

## Шаг 3. Создать Подключение к СУБД
### 3.1. Создать Context
>##### №1
1. Перейти в раздел Home/ETL/JdbcContext
2. Нажать “+” -> JdbcContext
3. Заполнить поле Name: humanresources
4. Сохранить

>##### №2
1. Перейти в раздел Home/ETL/JdbcContext
2. Нажать “+” -> JdbcContext
3. Заполнить поле Name: person
4. Сохранить

### 3.2. Создать Software System
>##### №1
1. Перейти в раздел Home/Connections/SoftwareSystem
2. Нажать “+” -> SoftwareSystem
3. Заполнить поля:
   - Name: humanresources
   - Project: выбрать labWorks
4. Сохранить
   
>##### №2
1. Перейти в раздел Home/Connections/SoftwareSystem
2. Нажать “+” -> Software System
3. Заполнить поля:
   - Name: person
   - Project: выбрать labWorks
4. Сохранить
> Важно! Name в JdbcContext должно совпадать с Name в Software System

> Оставшиеся поля заполнятся автоматически в конце Шага 2

### Шаг 3.3. Создать JdbcConnection
>##### №1
1. Перейти в раздел Home/Connections/JdbcConnection
2. Нажать “+” -> JdbcConnection
3. Заполнить поля 
    - Name: humanresources
    - Project: выбрать labWorks
    - Url: jdbc:postgresql://hivemetastore:5432/Adventureworks
    - Schema: humanresources
    - User: postgres
    - Password: new_password
    - Driver: org.postgresql.Driver
4. Сохранить
5. Запустить Test
6. Получить сообщение об успешном соединении
7. Закрыть сообщение об ошибке
   
>##### №2
1. Нажать Copy
2. Ввести name: person
3. Заменить поле:
    - Schema: person
4. Сохранить
5. Запустить Test
6. Получить сообщение об успешном соединении

### Шаг 3.4. Создать Deployment
>##### №1
1. Перейти в раздел Home/Connections/Deployment
2. Нажать “+” -> Deployment
3. Заполнить поля:
    - Name: humanresources
    - Project: выбрать labWorks
    - Connection: Выбрать humanresources
    - Software System: humanresources
4. Сохранить
5. Запустить Refresh Scheme
6. Получить сообщение об успешном соединении: [ "humanresources_at_humanresources" ]

>##### №2
1. Перейти в раздел Home/Connections/Deployment
2. Нажать “+” -> Deployment
3. Заполнить поля:
   - Name: person
   - Project: выбрать labWorks
   - Connection: Выбрать Person
   - Software System: Person
4. Сохранить
5. Запустить Refresh Scheme
6. Получить сообщение об успешном соединении: [ "person_at_person" ]

> Важно! Если при запуске Refresh Scheme возникла ошибка 
> "id to load is required for loading".
> Кнопка сохранить не отработала, нужно нажать её еще раз и повторить запуск Refresh Scheme

### Шаг 3.5. Проверить автоматически созданную Scheme
>##### №1
1. Перейти в раздел Home/Connections/Scheme
2. Проверить наличие humanresources_at_humanresources (она как раз создалась)
3. Перейти в режим редактирования 
4. Развернуть Tables (6 штук)

>##### №2
1. Перейти в раздел Home/Connections/Scheme
2. Проверить наличие person_at_person (она как раз создалась)
3. Перейти в режим редактирования
4. Развернуть Tables (13 штук)

## Шаг 4. Создать Transformation Step1

>##### №1
1. Перейти в раздел Home/ETL/Transformation
2. Нажать “+” -> Transformation
3. Заполнить поля:
   - Name: tr_salary_step1
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать labWorks
   - Spark Version: Выбрать SPARK3
   - Description:
        ```
        Формируем таблицу повышений за прошедший год
        ```
4. Сохранить

>##### №2
1. Нажать Run в нижней панели (снизу откроется панель инструментов)
2. Сделать Refresh страницы
3. Перейти в меню слева в autogenerated_tr_tr_salary_step1
4. Прокрутить вниз до Parameters
5. Нажать “+” -> Property (2 раза)
6. Раскрыть первый и заполнить поля:
   - Name: maxRate
   - Value: 20
   - Description: Бизнес правило - Максимальное повышение ЗП на 20% в год
7. Раскрыть первый и заполнить поля:
   - Name: currentDate
   - Value: 2013-12-01
   - Description: Текущая дата для Бизнес правила - Повышение ЗП максимум 1 раз в год
8. Сохранить
9. Вернуться в трансформацию
10. В нижней панели инструментов должны появиться два этих параметра

>##### №3
1. Перетащить на поле иконку из Source:
   - SQL
2. Нажать на неё
3. Справа в Свойствах:
   - Context: Выбрать humanresources
4. Сохранить

>##### №4
1. Под иконкой SQL нажать TXT (Edit SQL)
2. Открылся новый Tab SQL Editor SQL
3. Написать запрос, который возвращает все столбцы из таблицы employeepayhistory:
    ```
    select * from humanresources.employeepayhistory
    ```
4. Нажать Run
5. Посмотреть, что под запросом появилась чашка кофе
6. Посмотреть, что внизу закрутилась шестеренка и стала голубой
7. Подождать, пока запрос отработает и вернет таблицу
8. Нажать галочку (Apply) = Сохраняем запрос в SQL

>##### №4
1. Для задачи нужны поля:
   - businessentityid (id сотрудника, по нему потом подтянуть ФИО)
   - ratechangedate (дата повышения ЗП)
   - rate (процент повышения ЗП)
2. Написать запрос, который возвращает только нужные столбцы:
    ```
    select 
       businessentityid,
       ratechangedate,
       rate
   from humanresources.employeepayhistory
    ```
3. Нажать Run
4. Посмотреть, что под запросом появилась чашка кофе
5. Посмотреть, что внизу закрутилась шестеренка и стала голубой
6. Подождать, пока запрос отработает и вернет таблицу
7. Нажать галочку (Apply) = Сохраняем запрос в SQL
8. Закрыть Tab SQL Editor SQL
9. Сохранить


>##### №5
1. Нажать на SQL
2. Посмотреть, что в свойстве Statement появился запрос
3. Посмотреть, что в свойстве Output Port: OutputPort -> Fields появились 3 поля, которые вернулись из запроса с названием колонок и типом данных

>##### №6
1. Перетащить на поле иконку из Target:
   - Spark SQL
2. Нажать на неё
3. Справа в Свойствах:
   - Sql Ports: 
      - Нажать “+” -> Property (2 раза)
      - Развернуть появившееся поле
      - Заполнить поля:
         - Name: Salary
         - Alias: Salary
4. Соединить SQL и Spark SQL в рабочей области трансформации
5. Сохранить 

>##### №7
1. Под иконкой Spark нажать TXT (Edit Spark SQL)
2. Открылся новый Tab Spark Editor Spark_SQL
3. Написать запрос, который возвращает все столбцы из таблицы из SQL:
    ```
    select * from Salary
    ```
4. Нажать Run
5. Посмотреть, что под запросом появилась чашка кофе
6. Посмотреть, что внизу закрутилась шестеренка и стала голубой
7. Подождать, пока запрос отработает и вернет таблицу
8. Нажать галочку (Apply) = Сохраняем запрос в Spark SQL


>##### №8
1. Для задачи нужны поля:
   - businessentityid (id сотрудника, по нему потом подтянуть ФИО)
   - ratechangedate (дата повышения ЗП)
   - rate (процент повышения ЗП)
2. Нужна фильтрация по Бизнес Правилу: Повышение ЗП максимум 1 раз в год
   1.  Используем правило where:
    ```
    months_between(cast('${jobParameters("currentDate")}' as date), ratechangedate, true) <= 12
    ```
   2. В нем:
      1. Используется Property currentDate, со вспомогательной функцией jobParameters: '${jobParameters("currentDate")}'
2. Написать запрос, который возвращает только нужные столбцы:
    ```
    select 
       businessentityid,
       ratechangedate,
       rate
   from humanresources.employeepayhistory
    ```
3. Нажать Run
4. Посмотреть, что под запросом появилась чашка кофе
5. Посмотреть, что внизу закрутилась шестеренка и стала голубой
6. Подождать, пока запрос отработает и вернет таблицу
7. Нажать галочку (Apply) = Сохраняем запрос в SQL
8. Закрыть Tab SQL Editor SQL
9. Сохранить








5. Нажать “+” -> Property (2 раза)
6. Раскрыть первый и заполнить поля:
   - Name: maxRate
   - Value: 20
   - Description: Бизнес правило - Максимальное повышение ЗП на 20% в год
   

   
Повышения ЗП за прошедший год
---
#Это переписать
### Шаг 4. Спроектировать структуру Project

>##### №1
1. Перейти через BreadCrumb на вкладку Home
2. Выбрать раздел ETL
3. Выбрать раздел Transformation
4. Нажать “+” -> Transformation
5. Заполнить поля:
   - Name: tr_salary_step1_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject             
   - Spark Version: Выбрать SPARK3
   - Description: 
        ```
        Задача: Провести индексацию зарплат с учетом бизнес правил.
        Время проведения: декабрь 2013 года
        
        Правила бизнеса:
        1. Повышать ЗП максимум 2 раза в год
        2. Максимальное повышение ЗП 30% в год
        3. В случае несоблюдения правил 1 или 2, необходимо согласование руководителя компании.
        
        В Step 1: Формирование двух таблиц:
        1. Последнее повышение ЗП сотруднику
        2. Предпоследнее повышение ЗП сотруднику
        ```
6. Сохранить 

>##### №2
1. Перейти через BreadCrumb на вкладку Transformation
2. Нажать “+” -> Transformation
3. Заполнить поля:
   - Name: tr_salary_step2_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject             
   - Spark Version: Выбрать SPARK3
   - Description: 
        ```
        Задача: Провести индексацию зарплат с учетом бизнес правил.
        Время проведения: декабрь 2013 года
        
        Правила бизнеса:
        1. Повышать ЗП максимум 2 раза в год
        2. Максимальное повышение ЗП 30% в год
        3. В случае несоблюдения правил 1 или 2, необходимо согласование руководителя компании.
        
        В Step 2:
        1. Формирование таблицы с сотрудниками, кому повышали ЗП за предыдущий год.
        2. Вычисление % повышения ЗП в 2014 году
        
        Примечание:
        Чтобы посмотреть все таблицы в Hive, нужно в Livy ввести команду: "spark.sql("show tables").show()"
        ```
4. Сохранить 

>##### №3
1. Перейти через BreadCrumb на вкладку Transformation
2. Нажать “+” -> Transformation
3. Заполнить поля:
   - Name: tr_salary_step3_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject             
   - Spark Version: Выбрать SPARK3
   - Description: 
        ```
        Задача: Провести индексацию зарплат с учетом бизнес правил.
        Время проведения: декабрь 2013 года
        
        Правила бизнеса:
        1. Повышать ЗП максимум 2 раза в год
        2. Максимальное повышение ЗП 30% в год
        3. В случае несоблюдения правил 1 или 2, необходимо согласование руководителя компании.
        
        В Step 3: Формирование итоговой таблицы
        ```
4. Сохранить 

>##### №4
1. Перейти через BreadCrumb на вкладку ETL
2. Выбрать раздел Workflow
3. Нажать “+” -> Workflow
4. Заполнить поля:
   - Name: wf_salary_test
   - Label: Автоматически подставляется "= Name"
   - Project: выбрать testProject
5. Сохранить 

>##### №5
1. Увидеть открывшийся редактор Workflow
2. Перетащить на поле иконки:
     - Start
     - Transformation (3 шт)
     - Kill
     - End
3. Соединить их, как показано на рисунке:
    ![](img/1.%20Salary%20Analysis/Step%203.5.PNG)
4. Сохранить

>##### №6
1. Нажать на Start
2. Справа в Свойствах:
     - Name: заменить на "Start"
     - Label: Автоматически подставляется "= Name"
4. Сохранить

>##### №7
1. Нажать на Transformation_1
2. Справа в Свойствах:
     - Name: заменить на "Step1"
     - Label: Автоматически подставляется "= Name"
     - Transformation: Выбрать tr_salary_step1_test
3. Сохранить

>##### №8
1. Нажать на Transformation_2
2. Справа в Свойствах:
     - Name: заменить на "Step2"
     - Label: Автоматически подставляется "= Name"
     - Transformation: Выбрать tr_salary_step2_test
3. Сохранить

>##### №9
1. Нажать на Transformation_3
2. Справа в Свойствах:
     - Name: заменить на "Step3"
     - Label: Автоматически подставляется "= Name"
     - Transformation: Выбрать tr_salary_step3_test
3. Сохранить

>##### №10
1. Нажать на Kill_3
2. Справа в Свойствах:
     - Name: заменить на "Error"
     - Label: заменить на "Error"
     - Message: Ошибка запуска отчета анализа зарплат
3. Сохранить

>##### №11
1. Нажать на End_4
2. Справа в Свойствах:
     - Name: заменить на "Success"
     - Label: заменить на "Success"
3. Сохранить
4. Слева в Transformation должны появится три Transformation, подключенных к данному Workflow

>##### №12
1. Перейти через BreadCrumb на вкладку ETL
2. Выбрать раздел Project -> testProject
3. Убедиться, что Workflow и 3 Transformation подключены к проекту

